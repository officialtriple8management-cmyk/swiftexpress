<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Swift Express ‚Äî Admin Panel</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
    :root{--green:#00C896;--green2:#00A87E;--dark:#080C0F;--dark2:#0E1419;--dark3:#151C23;--border:#1E2830;--gray:#5A6B7A;--light:#B8C8D4;--white:#EEF4F8;--red:#FF5050;--gold:#F5A623;--purple:#8B5CF6;}
    body{background:var(--dark);color:var(--white);font-family:'DM Sans',sans-serif;display:flex;min-height:100vh;}
    .sidebar{width:240px;background:var(--dark2);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:28px 0;position:fixed;height:100vh;z-index:50;}
    .logo{font-family:'Syne',sans-serif;font-size:1.3rem;font-weight:800;padding:0 24px;margin-bottom:8px;}
    .logo span{color:var(--gold);}
    .admin-badge{margin:0 24px 28px;background:rgba(245,166,35,0.12);border:1px solid rgba(245,166,35,0.2);color:var(--gold);padding:4px 10px;border-radius:100px;font-size:0.72rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;width:fit-content;}
    .nav-label{font-size:0.7rem;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:var(--gray);padding:0 24px;margin-bottom:8px;}
    .nav-item{display:flex;align-items:center;gap:12px;padding:11px 14px;margin:0 10px;border-radius:8px;cursor:pointer;transition:all 0.2s;color:var(--gray);font-size:0.9rem;font-weight:500;}
    .nav-item:hover{background:var(--dark3);color:var(--white);}
    .nav-item.active{background:rgba(245,166,35,0.1);color:var(--gold);}
    .nav-sep{height:1px;background:var(--border);margin:12px 14px;}
    .sidebar-bottom{margin-top:auto;padding:0 14px;}
    .logout-btn{width:100%;background:rgba(255,80,80,0.1);border:1px solid rgba(255,80,80,0.2);color:var(--red);padding:10px;border-radius:8px;cursor:pointer;font-size:0.85rem;font-family:'DM Sans',sans-serif;}
    .main{margin-left:240px;flex:1;padding:32px;min-height:100vh;}
    .page{display:none;} .page.active{display:block;}
    .topbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:32px;}
    .page-title{font-family:'Syne',sans-serif;font-size:1.8rem;font-weight:800;}
    .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:28px;}
    .stat-card{background:var(--dark2);border:1px solid var(--border);border-radius:14px;padding:22px;}
    .stat-label{font-size:0.78rem;font-weight:600;letter-spacing:0.5px;text-transform:uppercase;color:var(--gray);margin-bottom:10px;}
    .stat-value{font-family:'Syne',sans-serif;font-size:2rem;font-weight:800;}
    .stat-sub{font-size:0.8rem;color:var(--gray);margin-top:6px;}
    .card{background:var(--dark2);border:1px solid var(--border);border-radius:14px;padding:24px;margin-bottom:20px;}
    .card-title{font-family:'Syne',sans-serif;font-size:1rem;font-weight:700;margin-bottom:20px;}
    table{width:100%;border-collapse:collapse;}
    th{font-size:0.72rem;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:var(--gray);padding:12px 14px;text-align:left;border-bottom:1px solid var(--border);}
    td{padding:13px 14px;font-size:0.87rem;border-bottom:1px solid rgba(30,40,48,0.5);vertical-align:middle;}
    tr:last-child td{border-bottom:none;}
    .badge{padding:4px 10px;border-radius:100px;font-size:0.72rem;font-weight:700;}
    .badge-pending{background:rgba(245,166,35,0.12);color:var(--gold);}
    .badge-approved{background:rgba(0,200,150,0.12);color:var(--green);}
    .badge-rejected{background:rgba(255,80,80,0.12);color:var(--red);}
    .badge-admin{background:rgba(139,92,246,0.15);color:var(--purple);}
    .badge-active{background:rgba(0,200,150,0.12);color:var(--green);}
    .badge-suspended{background:rgba(255,80,80,0.12);color:var(--red);}
    .btn{padding:7px 14px;border-radius:6px;border:none;cursor:pointer;font-size:0.8rem;font-weight:600;font-family:'DM Sans',sans-serif;transition:all 0.2s;margin:2px;}
    .btn-green{background:rgba(0,200,150,0.15);color:var(--green);border:1px solid rgba(0,200,150,0.2);}
    .btn-red{background:rgba(255,80,80,0.12);color:var(--red);border:1px solid rgba(255,80,80,0.2);}
    .btn-gold{background:rgba(245,166,35,0.12);color:var(--gold);border:1px solid rgba(245,166,35,0.2);}
    .btn-primary{background:var(--green);color:var(--dark);border:none;padding:10px 22px;border-radius:8px;font-weight:700;cursor:pointer;font-family:'Syne',sans-serif;}
    .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:200;align-items:center;justify-content:center;}
    .modal-overlay.open{display:flex;}
    .modal{background:var(--dark2);border:1px solid var(--border);border-radius:16px;padding:32px;width:90%;max-width:500px;}
    .modal-title{font-family:'Syne',sans-serif;font-size:1.3rem;font-weight:800;margin-bottom:6px;}
    .modal-sub{color:var(--gray);font-size:0.85rem;margin-bottom:22px;}
    .modal-close{float:right;background:none;border:none;color:var(--gray);font-size:1.2rem;cursor:pointer;}
    .field{margin-bottom:14px;}
    .field label{display:block;font-size:0.75rem;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;color:var(--light);margin-bottom:7px;}
    .field input,.field select,.field textarea{width:100%;background:var(--dark3);border:1px solid var(--border);color:var(--white);padding:12px 14px;border-radius:8px;font-size:0.9rem;font-family:'DM Sans',sans-serif;outline:none;}
    .field input:focus,.field select:focus{border-color:var(--gold);}
    .field input::placeholder{color:var(--gray);}
    .modal-btn{width:100%;padding:13px;border-radius:8px;border:none;font-family:'Syne',sans-serif;font-weight:700;font-size:0.95rem;cursor:pointer;margin-top:8px;}
    .modal-btn.gold{background:var(--gold);color:var(--dark);}
    .modal-btn.green{background:var(--green);color:var(--dark);}
    .modal-btn.red{background:var(--red);color:var(--white);}
    .msg{margin-top:12px;padding:11px 14px;border-radius:8px;font-size:0.85rem;display:none;}
    .msg.error{background:rgba(255,80,80,0.1);border:1px solid rgba(255,80,80,0.3);color:#FF8080;}
    .msg.success{background:rgba(0,200,150,0.1);border:1px solid rgba(0,200,150,0.3);color:var(--green);}
    .msg.show{display:block;}
    .search-bar{background:var(--dark3);border:1px solid var(--border);color:var(--white);padding:10px 16px;border-radius:8px;font-size:0.9rem;font-family:'DM Sans',sans-serif;outline:none;width:280px;}
  
.wallet-addr-card{background:var(--dark3);border:1px solid var(--border);border-radius:10px;padding:18px 20px;margin-bottom:12px;}
.wallet-addr-card h4{font-size:0.9rem;font-weight:700;margin-bottom:14px;display:flex;align-items:center;justify-content:space-between;gap:8px;color:var(--white);}
.wallet-addr-input{
  width:100%;background:var(--dark2);border:1px solid var(--border);
  color:var(--white);padding:10px 14px;border-radius:7px;
  font-size:12px;font-family:monospace;outline:none;
  transition:border 0.15s;margin-bottom:6px;
}
.wallet-addr-input:focus{border-color:var(--gold);}
.wallet-toggle{display:flex;align-items:center;gap:8px;margin-top:6px;font-size:12px;color:var(--gray);}
.toggle-switch{width:36px;height:20px;background:var(--border);border-radius:10px;position:relative;cursor:pointer;transition:all 0.2s;border:none;flex-shrink:0;}
.toggle-switch.on{background:var(--green);}
.toggle-switch::after{content:'';position:absolute;width:14px;height:14px;background:#fff;border-radius:50%;top:3px;left:3px;transition:all 0.2s;}
.toggle-switch.on::after{left:19px;}
.addr-row{display:flex;gap:10px;align-items:flex-start;margin-bottom:10px;padding-bottom:10px;border-bottom:1px solid var(--border);}
.addr-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}


  /* ‚îÄ‚îÄ KYC Filter Buttons ‚îÄ‚îÄ */
  .kyc-filter {
    background: var(--dark3);
    border: 1px solid var(--border);
    color: var(--gray);
    padding: 7px 18px;
    border-radius: 7px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    font-family: inherit;
    transition: all 0.15s;
  }
  .kyc-filter:hover { border-color: var(--gold); color: var(--gold); }
  .active-filter {
    background: var(--gold) !important;
    border-color: var(--gold) !important;
    color: #111 !important;
  }
  .kyc-card { background: var(--dark3); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 16px; }
  .kyc-card.pending-card { border-left: 3px solid #f59e0b; }
  .kyc-card.verified-card { border-left: 3px solid var(--green); }
  .kyc-card.rejected-card { border-left: 3px solid #e74c3c; }
  .kyc-info-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px,1fr)); gap: 10px; margin: 14px 0; }
  .kyc-info-item { background: rgba(255,255,255,0.04); border-radius: 8px; padding: 10px 12px; }
  .kyc-info-label { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--gray); margin-bottom: 3px; }
  .kyc-info-val { font-size: 13px; font-weight: 600; color: var(--white); word-break: break-all; }
  .kyc-doc-preview { max-width: 100%; max-height: 220px; object-fit: contain; border-radius: 8px; border: 1px solid var(--border); margin: 10px 0; display: block; }

</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="admin-loader" style="position:fixed;inset:0;background:#080C0F;z-index:9999;display:flex;align-items:center;justify-content:center;flex-direction:column;gap:14px;">
  <div style="font-family:Syne,sans-serif;font-size:1.4rem;font-weight:800;color:#F5A623">Swift<span style="color:#fff">Express</span></div>
  <div id="loader-msg" style="color:#5A6B7A;font-size:13px;min-height:20px">Loading admin panel...</div>
  <div style="width:180px;height:3px;background:#1E2830;border-radius:2px;overflow:hidden">
    <div style="height:100%;background:#F5A623;border-radius:2px;animation:ldBar 1.2s ease-in-out infinite"></div>
  </div>
  <button onclick="location.reload()" style="margin-top:8px;background:none;border:1px solid #1E2830;color:#5A6B7A;padding:6px 16px;border-radius:6px;cursor:pointer;font-size:12px">Refresh</button>
</div>
<style>
@keyframes ldBar{0%{width:0;margin-left:0}50%{width:60%;margin-left:20%}100%{width:0;margin-left:100%}}

/* ‚îÄ‚îÄ MOBILE RESPONSIVE ‚îÄ‚îÄ */
@media(max-width:768px){
  .sidebar{
    width:100%;height:auto;position:relative;
    flex-direction:row;flex-wrap:wrap;
    padding:12px;gap:4px;
    border-right:none;border-bottom:1px solid var(--border);
  }
  .logo{font-size:1rem;padding:4px 8px;margin-bottom:0;}
  .admin-badge{margin:0 8px 0 0;padding:3px 8px;font-size:0.65rem;}
  .nav-label{display:none;}
  .nav-sep{display:none;}
  .nav-item{padding:7px 10px;margin:0;font-size:0.78rem;border-radius:6px;}
  .sidebar-bottom{margin-top:0;margin-left:auto;padding:0;}
  .logout-btn{padding:7px 14px;font-size:0.78rem;border-radius:6px;}
  .main{margin-left:0;padding:16px;}
  .stats-grid{grid-template-columns:1fr 1fr;gap:10px;}
  .stat-value{font-size:1.4rem;}
  .page-title{font-size:1.2rem;}
  .topbar{flex-direction:column;align-items:flex-start;gap:6px;margin-bottom:16px;}
  .search-bar{width:100%;}
  table{font-size:0.78rem;}
  th,td{padding:8px 6px;}
  body{flex-direction:column;}
  .card{padding:14px;}
}
@media(max-width:480px){
  .stats-grid{grid-template-columns:1fr;}
  .sidebar{overflow-x:auto;flex-wrap:nowrap;white-space:nowrap;}
  .nav-item{flex-shrink:0;}
}
</style>

<aside class="sidebar">
  <div class="logo">Swift<span>Express</span></div>
  <div class="admin-badge">ADMIN PANEL</div>
  <div class="nav-label">Dashboard</div>
  <div class="nav-item active" onclick="showPage('overview',this)">üìä Overview</div>
  <div class="nav-item" onclick="showPage('users',this)">üë• All Users</div>
  <div class="nav-sep"></div>
  <div class="nav-label">Finance</div>
  <div class="nav-item" onclick="showPage('deposits',this)">üí∞ Deposits</div>
  <div class="nav-item" onclick="showPage('withdrawals',this)">üí∏ Withdrawals</div>
  <div class="nav-item" onclick="showPage('balances',this)">‚öñÔ∏è Edit Balances</div>
  <div class="nav-item" onclick="showPage('wallets',this)">üí≥ Wallet Addresses</div>
  <div class="nav-sep"></div>
  <div class="nav-label">Tools</div>
  <div class="nav-item" onclick="showPage('kyc',this)">ü™™ KYC Verification</div>
  <div class="nav-item" onclick="showPage('broadcast',this)">üì£ Broadcast Message</div>
  <div class="nav-item" onclick="showPage('notify',this)">üì¢ Send Notification</div>
  <div class="sidebar-bottom">
    <button class="logout-btn" onclick="doLogout()">üö™ Logout</button>
  </div>
</aside>

<main class="main">
  <!-- OVERVIEW -->
  <div class="page active" id="page-overview">
    <div class="topbar"><div class="page-title">üè¶ Admin Overview</div><div style="color:var(--gray);font-size:0.85rem" id="admin-date"></div></div>
    <div class="stats-grid">
      <div class="stat-card"><div class="stat-label">Total Users</div><div class="stat-value" id="stat-users">--</div><div class="stat-sub">Registered investors</div></div>
      <div class="stat-card"><div class="stat-label">Funds Under Management</div><div class="stat-value" style="color:var(--green)" id="stat-aum">--</div><div class="stat-sub">Total portfolio value</div></div>
      <div class="stat-card"><div class="stat-label">Pending Deposits</div><div class="stat-value" style="color:var(--gold)" id="stat-dep">--</div><div class="stat-sub">Awaiting approval</div></div>
      <div class="stat-card"><div class="stat-label">Pending Withdrawals</div><div class="stat-value" style="color:var(--red)" id="stat-wd">--</div><div class="stat-sub">Awaiting processing</div></div>
    </div>
    <div class="card">
      <div class="card-title">Pending Deposits</div>
      <table><thead><tr><th>User</th><th>Amount</th><th>Method</th><th>Tx Reference</th><th>Date</th><th>Actions</th></tr></thead>
      <tbody id="pending-deps"><tr><td colspan="6" style="text-align:center;color:var(--gray);padding:24px">Loading...</td></tr></tbody></table>
    </div>
    <div class="card">
      <div class="card-title">Pending Withdrawals</div>
      <table><thead><tr><th>User</th><th>Amount</th><th>Method</th><th>Wallet/Account</th><th>Date</th><th>Actions</th></tr></thead>
      <tbody id="pending-wds"><tr><td colspan="6" style="text-align:center;color:var(--gray);padding:24px">Loading...</td></tr></tbody></table>
    </div>

    <!-- ANALYTICS ROW -->
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px;padding:0 24px 16px;">
      <div class="stat-card"><div class="stat-label">Total Deposited</div><div class="stat-value" style="color:var(--green)" id="stat-total-dep">--</div><div class="stat-sub">All approved deposits</div></div>
      <div class="stat-card"><div class="stat-label">Total Withdrawn</div><div class="stat-value" style="color:#ef4444" id="stat-total-wd">--</div><div class="stat-sub">All approved withdrawals</div></div>
      <div class="stat-card"><div class="stat-label">KYC Pending</div><div class="stat-value" style="color:#f59e0b" id="stat-kyc">--</div><div class="stat-sub">Awaiting review</div></div>
      <div class="stat-card"><div class="stat-label">Verified Users</div><div class="stat-value" style="color:var(--green)" id="stat-verified">--</div><div class="stat-sub">KYC approved</div></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;padding:0 24px 24px;">
      <!-- Tier distribution -->
      <div class="card" style="margin:0;">
        <div class="card-title">üë• User Tier Distribution</div>
        <div id="tier-chart" style="display:flex;flex-direction:column;gap:10px;margin-top:8px;"></div>
      </div>
      <!-- Recent transactions -->
      <div class="card" style="margin:0;">
        <div class="card-title">üïê Recent Transactions</div>
        <div id="recent-tx-list" style="margin-top:8px;"></div>
      </div>
    </div>
  </div>

  <!-- USERS -->
  <div class="page" id="page-users">
    <div class="topbar"><div class="page-title">üë• All Users</div><input class="search-bar" placeholder="Search name or email..." oninput="filterUsers(this.value)"/></div>
    <div class="card"><table><thead><tr><th>Name</th><th>Email</th><th>Country</th><th>Tier</th><th>KYC</th><th>Joined</th><th>Actions</th></tr></thead>
    <tbody id="users-table"><tr><td colspan="7" style="text-align:center;color:var(--gray);padding:24px">Loading...</td></tr></tbody></table></div>
  </div>

  <!-- USER DETAIL PAGE -->
  <div class="page" id="page-user-detail">
    <div class="topbar">
      <button onclick="showPage('users',document.querySelector('[onclick*=users]'))" style="background:var(--dark3);border:1px solid var(--border);color:var(--white);padding:7px 14px;border-radius:7px;cursor:pointer;font-size:12px;font-family:inherit;display:flex;align-items:center;gap:6px;">‚Üê Back to Users</button>
      <div class="page-title" id="ud-page-title">User Detail</div>
    </div>
    <div style="padding:20px;max-width:900px;">

      <!-- Profile header -->
      <div style="background:var(--dark3);border:1px solid var(--border);border-radius:12px;padding:22px;margin-bottom:16px;display:flex;align-items:center;gap:18px;flex-wrap:wrap;">
        <div id="ud-avatar" style="width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,#f5a623,#e8932a);display:flex;align-items:center;justify-content:center;font-size:20px;font-weight:800;color:#fff;flex-shrink:0;">?</div>
        <div style="flex:1;">
          <div style="font-size:18px;font-weight:800;" id="ud-name">--</div>
          <div style="color:var(--gray);font-size:13px;" id="ud-email">--</div>
          <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
            <span id="ud-tier-badge" style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:10px;background:rgba(59,130,246,0.1);color:#3b82f6;">STARTER</span>
            <span id="ud-kyc-badge" style="font-size:11px;font-weight:700;padding:3px 10px;border-radius:10px;background:rgba(231,76,60,0.1);color:#e74c3c;">NOT VERIFIED</span>
          </div>
        </div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <button onclick="openEditBalFromDetail()" class="btn btn-gold">‚úèÔ∏è Edit Balance</button>
          <button onclick="openNotifForUser()" class="btn" style="background:rgba(59,130,246,0.1);color:#3b82f6;border-color:rgba(59,130,246,0.3);">üì¢ Send Notification</button>
        </div>
      </div>

      <!-- Info grid -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;" id="ud-info-grid">
        <div class="ud-info-card"><div class="ud-label">Phone</div><div class="ud-val" id="ud-phone">--</div></div>
        <div class="ud-info-card"><div class="ud-label">Age</div><div class="ud-val" id="ud-age">--</div></div>
        <div class="ud-info-card"><div class="ud-label">Country</div><div class="ud-val" id="ud-country">--</div></div>
        <div class="ud-info-card"><div class="ud-label">Member Since</div><div class="ud-val" id="ud-since">--</div></div>
        <div class="ud-info-card" style="grid-column:1/-1"><div class="ud-label">Home Address</div><div class="ud-val" id="ud-address">--</div></div>
      </div>

      <!-- Wallet balances -->
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;" id="ud-wallet-grid">
        <div class="ud-info-card" style="background:rgba(59,130,246,0.05);border-color:rgba(59,130,246,0.15);"><div class="ud-label">BTC Balance</div><div class="ud-val" id="ud-btc" style="color:#3b82f6;">$0.00</div></div>
        <div class="ud-info-card" style="background:rgba(16,185,129,0.05);border-color:rgba(16,185,129,0.15);"><div class="ud-label">Stocks</div><div class="ud-val" id="ud-stocks" style="color:var(--green);">$0.00</div></div>
        <div class="ud-info-card" style="background:rgba(139,92,246,0.05);border-color:rgba(139,92,246,0.15);"><div class="ud-label">Forex</div><div class="ud-val" id="ud-forex" style="color:#8b5cf6;">$0.00</div></div>
        <div class="ud-info-card" style="background:rgba(245,158,11,0.05);border-color:rgba(245,158,11,0.15);"><div class="ud-label">Total Profit</div><div class="ud-val" id="ud-profit">$0.00</div></div>
      </div>

      <!-- Transaction history -->
      <div class="card" style="margin-bottom:0;">
        <div class="card-title">Transaction History</div>
        <table><thead><tr><th>Date</th><th>Type</th><th>Amount</th><th>Method</th><th>Status</th></tr></thead>
        <tbody id="ud-tx-table"><tr><td colspan="5" style="text-align:center;color:var(--gray);padding:24px;">Loading...</td></tr></tbody></table>
      </div>
    </div>
  </div>

  <!-- DEPOSITS -->
  <div class="page" id="page-deposits">
    <div class="topbar"><div class="page-title">üí∞ All Deposits</div></div>
    <div class="card"><table><thead><tr><th>User</th><th>Amount</th><th>Method</th><th>Reference</th><th>Status</th><th>Date</th><th>Action</th></tr></thead>
    <tbody id="all-deps"><tr><td colspan="7" style="text-align:center;color:var(--gray);padding:24px">Loading...</td></tr></tbody></table></div>
  </div>

  <!-- WITHDRAWALS -->
  <div class="page" id="page-withdrawals">
    <div class="topbar"><div class="page-title">üí∏ All Withdrawals</div></div>
    <div class="card"><table><thead><tr><th>User</th><th>Amount</th><th>Method</th><th>Wallet/Account</th><th>Status</th><th>Date</th><th>Action</th></tr></thead>
    <tbody id="all-wds"><tr><td colspan="7" style="text-align:center;color:var(--gray);padding:24px">Loading...</td></tr></tbody></table></div>
  </div>

  <!-- EDIT BALANCES -->
  <div class="page" id="page-balances">
    <div class="topbar"><div class="page-title">‚öñÔ∏è Edit User Balances</div></div>
    <div class="card"><table><thead><tr><th>Name</th><th>Email</th><th>BTC ($)</th><th>Stocks ($)</th><th>Forex ($)</th><th>Profit ($)</th><th>Action</th></tr></thead>
    <tbody id="balance-table"><tr><td colspan="7" style="text-align:center;color:var(--gray);padding:24px">Loading...</td></tr></tbody></table></div>
  </div>


  <!-- WALLET ADDRESSES PAGE -->
  <div class="page" id="page-wallets">
    <div class="topbar">
      <div class="page-title">üí≥ Wallet Addresses</div>
    </div>
    <div class="card" style="max-width:720px">
      <div class="card-title">Manage Deposit Addresses</div>
      <p style="color:var(--gray);font-size:0.85rem;margin-bottom:22px;line-height:1.6">
        Add your real wallet addresses below. Add <strong>multiple per method</strong> for automatic rotation ‚Äî each deposit will use the least-used address.
      </p>
      <div id="wallet-addr-list">
        <div style="text-align:center;color:var(--gray);padding:32px">
          <div style="font-size:24px;margin-bottom:8px">‚è≥</div>
          Loading wallet addresses...
        </div>
      </div>
      <div style="display:flex;align-items:center;gap:12px;margin-top:24px;flex-wrap:wrap;">
        <button onclick="saveWalletAddresses()" class="btn-primary" style="font-family:inherit;padding:11px 26px;border-radius:8px;font-size:0.9rem">üíæ Save All Addresses</button>
        <button onclick="loadWalletAddresses()" style="background:var(--dark3);color:var(--gray);border:1px solid var(--border);padding:11px 20px;border-radius:8px;font-size:0.85rem;cursor:pointer;font-family:inherit">üîÑ Refresh</button>
      </div>
      <div style="margin-top:12px;font-size:0.8rem;color:var(--gray);line-height:1.6">
        üí° The system automatically gives each user the <strong>least-used address</strong> when they deposit.
      </div>
      <div id="wallet-save-msg" style="margin-top:14px;font-size:0.85rem;padding:11px 14px;border-radius:8px;display:none"></div>
    </div>
  </div>

  <!-- KYC VERIFICATION PAGE -->
  <div class="page" id="page-kyc">
    <div class="topbar">
      <div class="page-title">ü™™ KYC Verification</div>
    </div>
    <div style="padding:20px 24px;">
      <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:20px;">
        <div style="font-size:13px;color:var(--gray);">Review identity submissions. All user details are shown below.</div>
        <div style="display:flex;gap:8px;">
          <button onclick="filterKYC('all',this)" class="kyc-filter active-filter">All</button>
          <button onclick="filterKYC('pending',this)" class="kyc-filter">Pending</button>
          <button onclick="filterKYC('verified',this)" class="kyc-filter">Verified</button>
          <button onclick="filterKYC('rejected',this)" class="kyc-filter">Rejected</button>
        </div>
      </div>
      <div id="kyc-cards-container">
        <div style="text-align:center;color:var(--gray);padding:48px;">Loading submissions...</div>
      </div>
    </div>
  </div>


  <!-- BROADCAST PAGE -->
  <div class="page" id="page-broadcast">
    <div class="topbar"><div class="page-title">üì£ Broadcast Message</div></div>
    <div style="padding:24px;max-width:700px;">
      <div style="font-size:13px;color:var(--gray);margin-bottom:24px;">Send a notification to all users or a filtered group at once.</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px;">
        <div style="background:var(--dark3);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:22px;font-weight:800;color:var(--white);" id="bc-total-users">--</div>
          <div style="font-size:11px;color:var(--gray);margin-top:2px;">Total Users</div>
        </div>
        <div style="background:var(--dark3);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:22px;font-weight:800;color:var(--green);" id="bc-verified-users">--</div>
          <div style="font-size:11px;color:var(--gray);margin-top:2px;">Verified Users</div>
        </div>
        <div style="background:var(--dark3);border:1px solid var(--border);border-radius:10px;padding:14px;text-align:center;">
          <div style="font-size:22px;font-weight:800;color:var(--blue);" id="bc-recipient-count">--</div>
          <div style="font-size:11px;color:var(--gray);margin-top:2px;">Will Receive</div>
        </div>
      </div>
      <div style="background:var(--dark3);border:1px solid var(--border);border-radius:12px;padding:24px;">
        <div class="field" style="margin-bottom:16px;">
          <label>üìã Recipient Group</label>
          <select id="bc-group" onchange="updateBCCount()" style="margin-top:8px;width:100%;background:var(--dark2);border:1px solid var(--border);color:var(--white);padding:10px 12px;border-radius:7px;font-size:13px;font-family:inherit;cursor:pointer;">
            <option value="all">All Users</option>
            <option value="verified">Verified Users Only</option>
            <option value="unverified">Unverified Users Only</option>
            <option value="starter">Starter Tier</option>
            <option value="growth">Growth Tier</option>
            <option value="elite">Elite Tier</option>
            <option value="pending_kyc">Pending KYC</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:16px;">
          <label>üìå Notification Type</label>
          <select id="bc-type" style="margin-top:8px;width:100%;background:var(--dark2);border:1px solid var(--border);color:var(--white);padding:10px 12px;border-radius:7px;font-size:13px;font-family:inherit;">
            <option value="info">‚ÑπÔ∏è Info</option>
            <option value="success">‚úÖ Success / Good News</option>
            <option value="warning">‚ö†Ô∏è Warning</option>
            <option value="promo">üéâ Promotion</option>
          </select>
        </div>
        <div class="field" style="margin-bottom:16px;">
          <label>‚úèÔ∏è Title</label>
          <input type="text" id="bc-title" placeholder="e.g. Important Platform Update" style="margin-top:8px;width:100%;background:var(--dark2);border:1px solid var(--border);color:var(--white);padding:10px 12px;border-radius:7px;font-size:13px;font-family:inherit;box-sizing:border-box;"/>
        </div>
        <div class="field" style="margin-bottom:20px;">
          <label>üí¨ Message</label>
          <textarea id="bc-message" rows="4" placeholder="Write your message to users here..." style="margin-top:8px;width:100%;background:var(--dark2);border:1px solid var(--border);color:var(--white);padding:10px 12px;border-radius:7px;font-size:13px;font-family:inherit;resize:vertical;box-sizing:border-box;"></textarea>
        </div>
        <div id="bc-preview" style="display:none;background:var(--dark2);border:1px solid var(--border);border-radius:8px;padding:14px;margin-bottom:16px;">
          <div style="font-size:10px;text-transform:uppercase;letter-spacing:1px;color:var(--gray);margin-bottom:8px;">Preview</div>
          <div style="font-size:13px;font-weight:700;" id="bc-prev-title"></div>
          <div style="font-size:12px;color:var(--gray);margin-top:4px;" id="bc-prev-msg"></div>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <button onclick="previewBroadcast()" class="btn" style="background:var(--dark2);border:1px solid var(--border);color:var(--white);">üëÅ Preview</button>
          <button onclick="sendBroadcast()" class="btn btn-green" style="flex:1;">üì£ Send to <span id="bc-send-count">All</span> Users</button>
        </div>
        <div class="msg" id="bc-msg" style="margin-top:12px;"></div>
      </div>
      <div style="margin-top:24px;">
        <div style="font-size:13px;font-weight:700;margin-bottom:14px;">Recent Broadcasts</div>
        <div id="bc-history"><div style="color:var(--gray);font-size:12px;">Loading history...</div></div>
      </div>
    </div>
  </div>

  <!-- SEND NOTIFICATION -->
  <div class="page" id="page-notify">
    <div class="topbar"><div class="page-title">üì¢ Send Notification</div></div>
    <div class="card" style="max-width:560px">
      <div class="card-title">Send a message to any user</div>
      <div class="field"><label>Select User</label><select id="notif-user"><option value="">Loading...</option></select></div>
      <div class="field"><label>Title</label><input type="text" id="notif-title" placeholder="e.g. Deposit Approved"/></div>
      <div class="field"><label>Message</label><textarea id="notif-msg" rows="4" placeholder="Your deposit has been approved..." style="background:var(--dark3);border:1px solid var(--border);color:var(--white);padding:12px 14px;border-radius:8px;font-size:0.9rem;font-family:'DM Sans',sans-serif;outline:none;width:100%;resize:vertical;"></textarea></div>
      <button class="btn-primary" onclick="sendNotification()">Send Notification</button>
      <div class="msg" id="notif-result"></div>
    </div>
  </div>
</main>

<!-- EDIT BALANCE MODAL -->
<div class="modal-overlay" id="editBalModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('editBal')">X</button>
    <div class="modal-title">Edit Balance</div>
    <div class="modal-sub" id="editBal-name">User</div>
    <input type="hidden" id="editBal-uid"/>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="field"><label>BTC Balance ($)</label><input type="number" id="eb-btc" step="0.01" min="0" placeholder="0.00"/></div>
      <div class="field"><label>Stocks Balance ($)</label><input type="number" id="eb-stocks" step="0.01" min="0" placeholder="0.00"/></div>
      <div class="field"><label>Forex Balance ($)</label><input type="number" id="eb-forex" step="0.01" min="0" placeholder="0.00"/></div>
    </div>
    <div class="field" style="background:rgba(0,200,150,0.05);border:1px solid rgba(0,200,150,0.15);border-radius:8px;padding:14px;margin-top:4px;">
      <label style="color:var(--green)">üí∞ Total Profit / Loss ($)</label>
      <input type="number" id="eb-profit" step="0.01" placeholder="e.g. 500 or -200" style="margin-top:6px;"/>
      <div style="font-size:11px;color:var(--gray);margin-top:6px;">Enter positive for profit, negative for loss. This shows on user dashboard.</div>
    </div>
    <div class="field" style="background:rgba(245,158,11,0.05);border:1px solid rgba(245,158,11,0.15);border-radius:8px;padding:14px;margin-top:4px;">
      <label style="color:#f59e0b;">üèÜ Account Tier Level</label>
      <select id="eb-tier" style="margin-top:8px;width:100%;background:var(--dark2);border:1px solid var(--border);color:var(--white);padding:10px 12px;border-radius:7px;font-size:13px;font-family:inherit;cursor:pointer;">
        <option value="Starter">ü•â Starter ‚Äî 5% weekly, $100‚Äì$4,999</option>
        <option value="Growth">ü•à Growth ‚Äî 12% weekly, $5,000‚Äì$49,999</option>
        <option value="Elite">ü•á Elite ‚Äî 20% weekly, $50,000+</option>
      </select>
      <div style="font-size:11px;color:var(--gray);margin-top:6px;">Changing tier updates the user's subscription plan and dashboard display.</div>
    </div>
    <button class="modal-btn gold" onclick="saveBalance()" style="margin-top:8px;">üíæ Save Changes</button>
    <div class="msg" id="eb-msg"></div>
  </div>
</div>

<!-- REJECT MODAL -->
<div class="modal-overlay" id="rejectModal">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('reject')">X</button>
    <div class="modal-title">Reject Transaction</div>
    <div class="modal-sub">Add a note to explain the rejection to the user.</div>
    <input type="hidden" id="reject-id"/>
    <div class="field"><label>Reason</label><input type="text" id="reject-note" placeholder="e.g. Invalid transaction ID provided"/></div>
    <button class="modal-btn red" onclick="confirmReject()">Confirm Rejection</button>
    <div class="msg" id="reject-msg"></div>
  </div>
</div>

<script>
const {createClient}=supabase;
const sb=createClient('https://tnvbiricxztlxppdqphh.supabase.co','sb_publishable_sbf6NMGko9Jtm9ySrjk4UA_iNCn-pnI');
let allUsers=[];

async function init(){
  const loader=document.getElementById('admin-loader');
  const showLoader=()=>{if(loader)loader.style.display='flex';};
  const hideLoader=()=>{if(loader)loader.style.display='none';};
  const setLoaderMsg=(m)=>{const el=document.getElementById('loader-msg');if(el)el.textContent=m;};

  showLoader();
  setLoaderMsg('Checking session...');

  // Get session with retries
  let session=null;
  for(let i=0;i<15;i++){
    const {data}=await sb.auth.getSession();
    if(data?.session){session=data.session;break;}
    await new Promise(r=>setTimeout(r,400));
    setLoaderMsg('Loading... ('+(i+1)+')');
  }

  if(!session){
    setLoaderMsg('No session ‚Äî redirecting to login...');
    await new Promise(r=>setTimeout(r,800));
    window.location.replace('login.html');
    return;
  }

  setLoaderMsg('Verifying admin access...');

  // Check admin ‚Äî but DON'T redirect on failure, show error instead
  let isAdmin=false;
  try{
    const {data:p,error:pe}=await sb.from('profiles').select('is_admin').eq('id',session.user.id).single();
    if(pe) throw new Error(pe.message);
    isAdmin=p?.is_admin===true;
  }catch(e){
    // Show error ON the loader instead of redirecting
    setLoaderMsg('‚ö†Ô∏è Error: '+e.message+'. Retrying...');
    await new Promise(r=>setTimeout(r,1500));
    // One more try
    try{
      const {data:p2}=await sb.from('profiles').select('is_admin').eq('id',session.user.id).single();
      isAdmin=p2?.is_admin===true;
    }catch(e2){
      setLoaderMsg('‚ùå Cannot load profile. Please refresh the page.');
      return; // Don't redirect ‚Äî let user see the error
    }
  }

  if(!isAdmin){
    setLoaderMsg('‚ùå Access denied ‚Äî admin only.');
    await new Promise(r=>setTimeout(r,1500));
    window.location.replace('dashboard.html');
    return;
  }

  // ‚úÖ All good ‚Äî hide loader and show content
  hideLoader();
  const dateEl=document.getElementById('admin-date');
  if(dateEl) dateEl.textContent=new Date().toLocaleDateString('en',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  loadAll();

  sb.auth.onAuthStateChange((event)=>{
    if(event==='SIGNED_OUT') window.location.replace('login.html');
  });
}

async function loadAll(){
  await loadUsers();
  loadStats();
  loadWalletAddresses();
  loadPendingDeposits();
  loadPendingWithdrawals();
  loadAllDeposits();
  loadAllWithdrawals();
  // KYC badge count on nav
  updateKYCBadge();
  loadAnalytics();
  loadBalancesTable();
  populateNotifUsers();
}

async function loadUsers(){
  const {data:profiles}=await sb.from('profiles').select('*').order('created_at',{ascending:false});
  const {data:wallets}=await sb.from('wallets').select('user_id,tier,kyc_verified,kyc_status');
  const walletMap={};
  (wallets||[]).forEach(w=>walletMap[w.user_id]=w);
  allUsers=(profiles||[]).map(u=>({...u,...(walletMap[u.id]||{})}));
  renderUsers(allUsers);
}

function renderUsers(users){
  if(!users.length){document.getElementById('users-table').innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--gray);padding:24px">No users found</td></tr>';return;}
  document.getElementById('users-table').innerHTML=users.map(u=>{
    const tierColor={Starter:'#3b82f6',Growth:'#10b981',Elite:'#f59e0b'};
    const kycColor = u.kyc_verified?'var(--green)':u.kyc_status==='pending'?'#f59e0b':'var(--gray)';
    const kycText  = u.kyc_verified?'Verified':u.kyc_status==='pending'?'Pending':'Not Verified';
    return `<tr>
    <td><strong>${u.full_name||'--'}</strong></td>
    <td style="color:var(--gray);font-size:0.8rem">${u.email||'--'}</td>
    <td style="font-size:0.8rem">${u.country||'--'}</td>
    <td><span style="background:${tierColor[u.tier||'Starter']}22;color:${tierColor[u.tier||'Starter']};border:1px solid ${tierColor[u.tier||'Starter']}44;padding:2px 8px;border-radius:8px;font-size:10px;font-weight:700;">${u.tier||'Starter'}</span></td>
    <td><span style="color:${kycColor};font-size:11px;font-weight:600;">${kycText}</span></td>
    <td style="color:var(--gray);font-size:0.8rem">${new Date(u.created_at).toLocaleDateString()}</td>
    <td>
      <button class="btn" style="background:rgba(59,130,246,0.1);color:#3b82f6;border-color:rgba(59,130,246,0.2);" onclick="viewUserDetail('${u.id}')">üëÅ View</button>
      ${u.is_suspended?`<button class="btn btn-green" onclick="toggleSuspend('${u.id}',false)">Unsuspend</button>`:`<button class="btn btn-red" onclick="toggleSuspend('${u.id}',true)">Suspend</button>`}
      ${!u.is_admin?`<button class="btn btn-gold" onclick="makeAdmin('${u.id}')">Admin</button>`:''}
    </td></tr>`;
  }).join('');
}

function filterUsers(q){
  renderUsers(allUsers.filter(u=>(u.full_name||'').toLowerCase().includes(q.toLowerCase())||(u.email||'').toLowerCase().includes(q.toLowerCase())));
}

async function loadStats(){
  const {data:w}=await sb.from('wallets').select('btc_balance,stocks_balance,forex_balance');
  const aum=(w||[]).reduce((s,x)=>s+(x.btc_balance||0)+(x.stocks_balance||0)+(x.forex_balance||0),0);
  const {data:pd}=await sb.from('transactions').select('id').eq('type','deposit').eq('status','pending');
  const {data:pw}=await sb.from('transactions').select('id').eq('type','withdrawal').eq('status','pending');
  document.getElementById('stat-users').textContent=allUsers.length;
  document.getElementById('stat-aum').textContent='$'+aum.toLocaleString('en',{minimumFractionDigits:2,maximumFractionDigits:2});
  document.getElementById('stat-dep').textContent=pd?.length||0;
  document.getElementById('stat-wd').textContent=pw?.length||0;
}

async function loadPendingDeposits(){
  const el=document.getElementById('pending-deps');
  const {data}=await sb.from('transactions').select('*').eq('type','deposit').eq('status','pending').order('created_at',{ascending:false});
  if(!data?.length){el.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:24px">No pending deposits</td></tr>';return;}
  const uids=[...new Set(data.map(t=>t.user_id))];
  const {data:profs}=await sb.from('profiles').select('id,full_name,email').in('id',uids);
  const pm={};(profs||[]).forEach(p=>pm[p.id]=p);
  el.innerHTML=data.map(t=>`<tr>
    <td><strong>${pm[t.user_id]?.full_name||'--'}</strong><br><small style="color:var(--gray)">${pm[t.user_id]?.email||''}</small></td>
    <td style="color:var(--green);font-weight:700">$${parseFloat(t.amount).toLocaleString()}</td>
    <td>${t.payment_method||'--'}</td>
    <td style="color:var(--gray);font-size:0.8rem;max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${t.proof_url||'--'}</td>
    <td style="color:var(--gray);font-size:0.8rem">${new Date(t.created_at).toLocaleDateString()}</td>
    <td><button class="btn btn-green" onclick="approveDeposit('${t.id}','${t.user_id}',${t.amount})">Approve</button>
    <button class="btn btn-red" onclick="openReject('${t.id}')">Reject</button></td></tr>`).join('');
}

async function loadPendingWithdrawals(){
  const el=document.getElementById('pending-wds');
  const {data}=await sb.from('transactions').select('*').eq('type','withdrawal').eq('status','pending').order('created_at',{ascending:false});
  if(!data?.length){el.innerHTML='<tr><td colspan="6" style="text-align:center;color:var(--gray);padding:24px">No pending withdrawals</td></tr>';return;}
  const uids=[...new Set(data.map(t=>t.user_id))];
  const {data:profs}=await sb.from('profiles').select('id,full_name,email').in('id',uids);
  const pm={};(profs||[]).forEach(p=>pm[p.id]=p);
  el.innerHTML=data.map(t=>`<tr>
    <td><strong>${pm[t.user_id]?.full_name||'--'}</strong><br><small style="color:var(--gray)">${pm[t.user_id]?.email||''}</small></td>
    <td style="color:var(--red);font-weight:700">$${parseFloat(t.amount).toLocaleString()}</td>
    <td>${t.payment_method||'--'}</td>
    <td style="color:var(--gray);font-size:0.8rem">${t.proof_url||'--'}</td>
    <td style="color:var(--gray);font-size:0.8rem">${new Date(t.created_at).toLocaleDateString()}</td>
    <td><button class="btn btn-green" onclick="approveWithdrawal('${t.id}','${t.user_id}',${t.amount})">Approve</button>
    <button class="btn btn-red" onclick="openReject('${t.id}')">Reject</button></td></tr>`).join('');
}

async function loadAllDeposits(){
  const {data:_deps}=await sb.from('transactions').select('*').eq('type','deposit').order('created_at',{ascending:false});
  const data=_deps||[];
  if(data.length){const uids=[...new Set(data.map(t=>t.user_id))];const {data:pr}=await sb.from('profiles').select('id,full_name,email').in('id',uids);const pm={};(pr||[]).forEach(p=>pm[p.id]=p);data.forEach(t=>t._p=pm[t.user_id]||{});}
  document.getElementById('all-deps').innerHTML=(data||[]).map(t=>`<tr>
    <td>${t._p?.full_name||'--'}</td>
    <td style="font-weight:600">$${parseFloat(t.amount).toLocaleString()}</td>
    <td>${t.payment_method||'--'}</td>
    <td style="color:var(--gray);font-size:0.8rem">${t.proof_url||'--'}</td>
    <td><span class="badge badge-${t.status}">${cap(t.status)}</span></td>
    <td style="color:var(--gray);font-size:0.8rem">${new Date(t.created_at).toLocaleDateString()}</td>
    <td>${t.status==='pending'?`<button class="btn btn-green" onclick="approveDeposit('${t.id}','${t.user_id}',${t.amount})">Approve</button>`:'--'}</td></tr>`).join('')||'<tr><td colspan="7" style="text-align:center;color:var(--gray);padding:24px">No deposits</td></tr>';
}

async function loadAllWithdrawals(){
  const {data:_wds}=await sb.from('transactions').select('*').eq('type','withdrawal').order('created_at',{ascending:false});
  const data=_wds||[];
  if(data.length){const uids=[...new Set(data.map(t=>t.user_id))];const {data:pr}=await sb.from('profiles').select('id,full_name,email').in('id',uids);const pm={};(pr||[]).forEach(p=>pm[p.id]=p);data.forEach(t=>t._p=pm[t.user_id]||{});}
  document.getElementById('all-wds').innerHTML=(data||[]).map(t=>`<tr>
    <td>${t._p?.full_name||'--'}</td>
    <td style="font-weight:600">$${parseFloat(t.amount).toLocaleString()}</td>
    <td>${t.payment_method||'--'}</td>
    <td style="color:var(--gray);font-size:0.8rem">${t.proof_url||'--'}</td>
    <td><span class="badge badge-${t.status}">${cap(t.status)}</span></td>
    <td style="color:var(--gray);font-size:0.8rem">${new Date(t.created_at).toLocaleDateString()}</td>
    <td>${t.status==='pending'?`<button class="btn btn-green" onclick="approveWithdrawal('${t.id}','${t.user_id}',${t.amount})">Approve</button>`:'--'}</td></tr>`).join('')||'<tr><td colspan="7" style="text-align:center;color:var(--gray);padding:24px">No withdrawals</td></tr>';
}

async function loadBalancesTable(){
  const {data:_wallets}=await sb.from('wallets').select('*');
  const wdata=_wallets||[];
  if(wdata.length){const uids=wdata.map(w=>w.user_id).filter(Boolean);const {data:pr}=await sb.from('profiles').select('id,full_name,email').in('id',uids);const pm={};(pr||[]).forEach(p=>pm[p.id]=p);wdata.forEach(w=>w._p=pm[w.user_id]||{});}
  document.getElementById('balance-table').innerHTML=(wdata||[]).map(w=>{ const data=wdata;
    const tier=w.tier||'Starter';
    const tierColors={Starter:'#3b82f6',Growth:'#10b981',Elite:'#f59e0b'};
    const tc=tierColors[tier]||tierColors.Starter;
    return `<tr>
    <td><strong>${w._p?.full_name||'--'}</strong></td>
    <td style="color:var(--gray);font-size:0.8rem">${w._p?.email||'--'}</td>
    <td>$${(w.btc_balance||0).toLocaleString('en',{minimumFractionDigits:2})}</td>
    <td>$${(w.stocks_balance||0).toLocaleString('en',{minimumFractionDigits:2})}</td>
    <td>$${(w.forex_balance||0).toLocaleString('en',{minimumFractionDigits:2})}</td>
    <td style="color:var(--green)">$${(w.total_profit||0).toLocaleString('en',{minimumFractionDigits:2})}</td>
    <td><span style="background:${tc}22;color:${tc};border:1px solid ${tc}44;padding:3px 10px;border-radius:10px;font-size:11px;font-weight:700;">${tier}</span></td>
    <td><button class="btn btn-gold" onclick="openEditBal('${w.user_id}','${w._profile?.full_name||'User'}',${w.btc_balance||0},${w.stocks_balance||0},${w.forex_balance||0},${w.total_profit||0})">Edit</button></td></tr>`;
  }).join('')||'<tr><td colspan="7" style="text-align:center;color:var(--gray);padding:24px">No data</td></tr>';
}

function populateNotifUsers(){
  document.getElementById('notif-user').innerHTML='<option value="">Select user...</option>'+allUsers.filter(u=>!u.is_admin).map(u=>`<option value="${u.id}">${u.full_name||u.email}</option>`).join('');
}

async function approveDeposit(txId,userId,amount){
  if(!confirm(`Approve deposit of $${amount}? This will add $${amount} to the user's balance.`))return;
  // Get current wallet
  const {data:w, error:we}=await sb.from('wallets').select('btc_balance,total_deposited').eq('user_id',userId).single();
  if(we){alert('Error reading wallet: '+we.message);return;}
  const newBal=(parseFloat(w?.btc_balance)||0)+parseFloat(amount);
  const newDep=(parseFloat(w?.total_deposited)||0)+parseFloat(amount);
  // Update wallet balance
  const {error:ue}=await sb.from('wallets').update({
    btc_balance:newBal,
    total_deposited:newDep
  }).eq('user_id',userId);
  if(ue){alert('Error updating balance: '+ue.message);return;}
  // Mark transaction approved
  const {error:te}=await sb.from('transactions').update({
    status:'approved',
    admin_note:'Approved by admin'
  }).eq('id',txId);
  if(te){alert('Balance updated but transaction error: '+te.message);}
  // Send notification
  await sb.from('notifications').insert({
    user_id:userId,
    title:'Deposit Approved ‚úÖ',
    message:`Your deposit of $${parseFloat(amount).toLocaleString()} has been approved and credited to your account.`,
    is_read:false
  });
  alert(`‚úÖ Success! $${parseFloat(amount).toLocaleString()} added to user balance.`);
  loadAll();
}

async function approveWithdrawal(txId,userId,amount){
  if(!confirm(`Approve withdrawal of $${amount}? This will deduct from user balance.`))return;
  const {data:w, error:we}=await sb.from('wallets').select('btc_balance,total_withdrawn').eq('user_id',userId).single();
  if(we){alert('Error reading wallet: '+we.message);return;}
  const newBal=Math.max(0,(parseFloat(w?.btc_balance)||0)-parseFloat(amount));
  const newWith=(parseFloat(w?.total_withdrawn)||0)+parseFloat(amount);
  const {error:ue}=await sb.from('wallets').update({
    btc_balance:newBal,
    total_withdrawn:newWith
  }).eq('user_id',userId);
  if(ue){alert('Error updating balance: '+ue.message);return;}
  const {error:te}=await sb.from('transactions').update({
    status:'approved',
    admin_note:'Withdrawal processed by admin'
  }).eq('id',txId);
  if(te){alert('Balance updated but transaction error: '+te.message);}
  await sb.from('notifications').insert({
    user_id:userId,
    title:'Withdrawal Processed ‚úÖ',
    message:`Your withdrawal of $${parseFloat(amount).toLocaleString()} has been processed successfully.`,
    is_read:false
  });
  alert(`‚úÖ Withdrawal of $${parseFloat(amount).toLocaleString()} approved!`);
  loadAll();
}

function openReject(txId){
  document.getElementById('reject-id').value=txId;
  document.getElementById('reject-note').value='';
  openModal('reject');
}
async function confirmReject(){
  const txId=document.getElementById('reject-id').value;
  const note=document.getElementById('reject-note').value.trim();
  const msg=document.getElementById('reject-msg');
  if(!note)return showMsg(msg,'Add a reason','error');
  await sb.from('transactions').update({status:'rejected',admin_note:note}).eq('id',txId);
  showMsg(msg,'Transaction rejected','success');
  setTimeout(()=>{closeModal('reject');loadAll();},1000);
}

async function openEditBal(uid,name,btc,stocks,forex,profit){
  document.getElementById('editBal-uid').value=uid;
  document.getElementById('editBal-name').textContent='Editing: '+name;
  document.getElementById('eb-btc').value=btc;
  document.getElementById('eb-stocks').value=stocks;
  document.getElementById('eb-forex').value=forex;
  document.getElementById('eb-profit').value=profit;
  // Load current tier from DB
  const {data:w} = await sb.from('wallets').select('tier').eq('user_id',uid).single();
  const tierSel = document.getElementById('eb-tier');
  if(tierSel) tierSel.value = (w && w.tier) ? w.tier : 'Starter';
  openModal('editBal');
}
async function saveBalance(){
  const uid=document.getElementById('editBal-uid').value;
  const msg=document.getElementById('eb-msg');
  const tier=document.getElementById('eb-tier').value||'Starter';
  const {error}=await sb.from('wallets').update({
    btc_balance:parseFloat(document.getElementById('eb-btc').value)||0,
    stocks_balance:parseFloat(document.getElementById('eb-stocks').value)||0,
    forex_balance:parseFloat(document.getElementById('eb-forex').value)||0,
    total_profit:parseFloat(document.getElementById('eb-profit').value)||0,
    tier:tier
  }).eq('user_id',uid);
  if(error)return showMsg(msg,'Error saving: '+error.message,'error');
  showMsg(msg,'Balance and tier updated to '+tier+'!','success');
  setTimeout(()=>{closeModal('editBal');loadAll();},1200);
}

async function sendNotification(){
  const uid=document.getElementById('notif-user').value;
  const title=document.getElementById('notif-title').value.trim();
  const message=document.getElementById('notif-msg').value.trim();
  const msg=document.getElementById('notif-result');
  if(!uid||!title||!message)return showMsg(msg,'Fill in all fields','error');
  const {error}=await sb.from('notifications').insert({user_id:uid,title,message,is_read:false});
  if(error)return showMsg(msg,'Error sending','error');
  showMsg(msg,'Notification sent!','success');
  document.getElementById('notif-title').value='';
  document.getElementById('notif-msg').value='';
}

async function toggleSuspend(uid,suspend){
  if(!confirm((suspend?'Suspend':'Unsuspend')+' this user?'))return;
  await sb.from('profiles').update({is_suspended:suspend}).eq('id',uid);
  loadUsers();
}
async function makeAdmin(uid){
  if(!confirm('Give admin access to this user? They will have full control.'))return;
  await sb.from('profiles').update({is_admin:true}).eq('id',uid);
  loadUsers();
}

async function updateKYCBadge(){
  const {data} = await sb.from('wallets').select('user_id').eq('kyc_status','pending').eq('kyc_verified',false);
  const count = data?.length||0;
  const navItem = document.querySelector('[onclick*="kyc"]');
  if(navItem && count>0){
    navItem.innerHTML = `ü™™ KYC Verification <span style="background:#e74c3c;color:#fff;border-radius:10px;padding:1px 7px;font-size:10px;font-weight:800;margin-left:6px;">${count}</span>`;
  }
}

let allKYCData = [];
let kycFilter = 'all';

async function loadKYC(){
  const container = document.getElementById('kyc-cards-container');
  if(!container) return;
  container.innerHTML = '<div style="text-align:center;color:var(--gray);padding:48px;">Loading submissions...</div>';

  try {
    // Get ALL wallets, then filter in JS - avoids issues with null/empty column filtering
    const {data: walletData, error: wErr} = await sb.from('wallets')
      .select('*')
      .order('kyc_submitted_at', {ascending: false, nullsFirst: false});

    if(wErr) throw new Error('DB error: ' + wErr.message);

    // Filter to only rows that have a KYC submission
    const kycWallets = (walletData || []).filter(w =>
      w.kyc_status && w.kyc_status !== '' && w.kyc_status !== null
    );

    if(kycWallets.length === 0){
      container.innerHTML = '<div style="text-align:center;color:var(--gray);padding:48px;font-size:14px;"><div style="font-size:36px;margin-bottom:12px;">üì≠</div><div style="font-weight:600;color:var(--white);">No KYC submissions yet</div><div style="font-size:12px;margin-top:6px;">Submissions will appear here once users complete the KYC form.</div></div>';
      return;
    }

    // Fetch matching profiles separately
    const userIds = kycWallets.map(w => w.user_id).filter(Boolean);
    let profileMap = {};
    if(userIds.length > 0){
      const {data: profileData} = await sb.from('profiles')
        .select('id, full_name, email, phone, country, age')
        .in('id', userIds);
      (profileData || []).forEach(p => { profileMap[p.id] = p; });
    }

    // Merge and store
    allKYCData = kycWallets.map(w => ({ ...w, _profile: profileMap[w.user_id] || {} }));
    renderKYCCards();

  } catch(err) {
    console.error('loadKYC error:', err);
    container.innerHTML = '<div style="text-align:center;color:#e74c3c;padding:48px;"><div style="font-size:32px;margin-bottom:10px;">‚ö†Ô∏è</div><div style="font-size:14px;font-weight:600;">Error: ' + err.message + '</div><div style="font-size:12px;margin-top:8px;color:var(--gray);">Check the browser console for details.</div></div>';
  }
}

function filterKYC(filter, btn){
  kycFilter = filter;
  document.querySelectorAll('.kyc-filter').forEach(b=>b.classList.remove('active-filter'));
  if(btn) btn.classList.add('active-filter');
  renderKYCCards();
}

function renderKYCCards(){
  const container = document.getElementById('kyc-cards-container');
  if(!container) return;

  let data = allKYCData;
  if(kycFilter === 'pending')  data = data.filter(w => w.kyc_status==='pending' && !w.kyc_verified);
  if(kycFilter === 'verified') data = data.filter(w => w.kyc_verified);
  if(kycFilter === 'rejected') data = data.filter(w => w.kyc_status==='rejected');

  if(!data.length){
    container.innerHTML = '<div style="text-align:center;color:var(--gray);padding:48px;font-size:14px;">No submissions in this category.</div>';
    return;
  }

  container.innerHTML = data.map(w => {
    const isVerified  = w.kyc_verified;
    const isPending   = w.kyc_status === 'pending' && !isVerified;
    const isRejected  = w.kyc_status === 'rejected';
    const statusColor = isVerified ? 'var(--green)' : isPending ? '#f59e0b' : '#e74c3c';
    const statusText  = isVerified ? '‚úÖ Verified' : isPending ? '‚è≥ Pending Review' : '‚ùå Rejected';
    const cardClass   = isVerified ? 'verified-card' : isPending ? 'pending-card' : 'rejected-card';

    // Use kyc_* snapshot fields first, fall back to profiles join
    const fullName = w.kyc_full_name || w._profile?.full_name || '--';
    const email    = w.kyc_email    || w._profile?.email    || '--';
    const phone    = w.kyc_phone    || w._profile?.phone    || '--';
    const age      = w.kyc_age      || w._profile?.age      || '--';
    const country  = w.kyc_country  || w._profile?.country  || '--';
    const address  = w.kyc_address  || '--';
    const submittedDate = w.kyc_submitted_at ? new Date(w.kyc_submitted_at).toLocaleString() : '--';

    const idTypeLabel = {passport:'International Passport', national_id:'National ID Card', drivers_license:"Driver's License"}[w.kyc_id_type] || w.kyc_id_type || '--';

    // Document preview ‚Äî show image inline if it's an image
    const docUrl = w.kyc_document_url || '';
    // Support both base64 data URIs and regular URLs
    const isBase64  = docUrl.startsWith('data:');
    const isImgUrl  = !isBase64 && /\.(jpg|jpeg|png|webp|gif)(\?|$)/i.test(docUrl);
    const isPdfUrl  = !isBase64 && /\.pdf(\?|$)/i.test(docUrl);
    const isImgB64  = isBase64 && docUrl.startsWith('data:image');
    const docHtml = !docUrl
      ? '<span style="color:var(--gray);font-size:12px;">No document uploaded</span>'
      : (isImgUrl || isImgB64)
        ? `<img src="${docUrl}" class="kyc-doc-preview" onclick="openDocFull('${isImgB64 ? 'base64img' : docUrl}')" title="Click to view full size" style="cursor:zoom-in;"/>`
        : `<a href="${docUrl}" target="_blank" style="display:inline-flex;align-items:center;gap:6px;background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.2);color:var(--blue);padding:8px 14px;border-radius:7px;font-size:12px;font-weight:600;text-decoration:none;margin-top:8px;">üìÑ View Document</a>`;

    return `<div class="kyc-card ${cardClass}">
      <!-- Header row -->
      <div style="display:flex;align-items:flex-start;justify-content:space-between;flex-wrap:wrap;gap:10px;">
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="width:44px;height:44px;border-radius:50%;background:linear-gradient(135deg,#3b82f6,#06b6d4);display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:800;color:#fff;flex-shrink:0;">${(fullName||'?').slice(0,2).toUpperCase()}</div>
          <div>
            <div style="font-size:14px;font-weight:700;">${fullName}</div>
            <div style="font-size:11px;color:var(--gray);">${email}</div>
            <div style="font-size:10px;color:var(--gray);margin-top:2px;">Submitted: ${submittedDate}</div>
          </div>
        </div>
        <span style="background:${statusColor}22;color:${statusColor};border:1px solid ${statusColor}44;padding:4px 12px;border-radius:20px;font-size:11px;font-weight:800;">${statusText}</span>
      </div>

      <!-- Personal info grid -->
      <div class="kyc-info-grid">
        <div class="kyc-info-item"><div class="kyc-info-label">Phone</div><div class="kyc-info-val">${phone}</div></div>
        <div class="kyc-info-item"><div class="kyc-info-label">Age</div><div class="kyc-info-val">${age}</div></div>
        <div class="kyc-info-item"><div class="kyc-info-label">Country</div><div class="kyc-info-val">${country}</div></div>
        <div class="kyc-info-item"><div class="kyc-info-label">ID Type</div><div class="kyc-info-val">${idTypeLabel}</div></div>
        <div class="kyc-info-item"><div class="kyc-info-label">ID Number</div><div class="kyc-info-val">${w.kyc_id_number||'--'}</div></div>
        <div class="kyc-info-item" style="grid-column:1/-1"><div class="kyc-info-label">Home Address</div><div class="kyc-info-val">${address}</div></div>
      </div>

      <!-- Document -->
      <div style="font-size:11px;color:var(--gray);font-weight:700;text-transform:uppercase;letter-spacing:0.8px;margin-bottom:6px;">ID Document</div>
      ${docHtml}

      <!-- Action buttons ‚Äî only for pending -->
      ${isPending ? `
      <div style="display:flex;gap:10px;margin-top:16px;padding-top:14px;border-top:1px solid var(--border);">
        <button class="btn btn-green" onclick="verifyKYC('${w.user_id}',true)" style="flex:1;padding:10px;">‚úÖ Approve &amp; Verify</button>
        <button class="btn" onclick="verifyKYC('${w.user_id}',false)" style="flex:1;padding:10px;background:rgba(231,76,60,0.1);color:#e74c3c;border:1px solid rgba(231,76,60,0.2);">‚ùå Reject</button>
      </div>` : isVerified ? `
      <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border);font-size:12px;color:var(--green);">‚úÖ This user has been verified.</div>` : `
      <div style="margin-top:14px;padding-top:12px;border-top:1px solid var(--border);display:flex;gap:10px;align-items:center;">
        <span style="font-size:12px;color:#e74c3c;flex:1;">‚ùå This submission was rejected.</span>
        <button class="btn btn-green" onclick="verifyKYC('${w.user_id}',true)" style="padding:8px 16px;font-size:12px;">Approve Anyway</button>
      </div>`}
    </div>`;
  }).join('');
}

function openDocFull(src){
  // open base64 image in new tab
  if(src === 'base64img') return; // img is already shown inline
  window.open(src, '_blank');
}

function closeKYCModal(){
  document.getElementById('kyc-modal-overlay').style.display = 'none';
  document.getElementById('kyc-detail-modal').style.display  = 'none';
}

async function verifyKYC(userId, approve){
  const label = approve ? 'approve and verify' : 'reject';
  if(!confirm('Are you sure you want to ' + label + ' this KYC submission?')) return;

  // 1. Update wallet KYC status
  const {error} = await sb.from('wallets').update({
    kyc_verified: approve,
    kyc_status:   approve ? 'verified' : 'rejected'
  }).eq('user_id', userId);

  if(error){ alert('Error: ' + error.message); return; }

  // 2. Send notification to the user so their dashboard updates
  try {
    await sb.from('notifications').insert({
      user_id: userId,
      title:   approve ? '‚úÖ KYC Verified' : '‚ùå KYC Rejected',
      message: approve
        ? 'Congratulations! Your identity has been verified successfully. You now have full access to all platform features.'
        : 'Your KYC submission was not approved. Please re-submit with a clearer ID document.',
      type:    'kyc',
      read:    false,
      is_read: false,
    });
  } catch(e){ console.warn('Notification insert failed:', e.message); }

  // 3. Update local cache so re-render is instant
  const entry = allKYCData.find(w => w.user_id === userId);
  if(entry){ entry.kyc_verified = approve; entry.kyc_status = approve ? 'verified' : 'rejected'; }

  renderKYCCards();
  updateKYCBadge();

  // 4. Show toast
  const toast = document.createElement('div');
  toast.textContent = approve ? '‚úÖ User successfully verified!' : '‚ùå KYC submission rejected.';
  toast.style.cssText = 'position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:'+(approve?'#10b981':'#e74c3c')+';color:#fff;padding:14px 28px;border-radius:10px;font-size:13px;font-weight:700;z-index:9999;box-shadow:0 4px 20px rgba(0,0,0,0.4);';
  document.body.appendChild(toast);
  setTimeout(()=>toast.remove(), 3500);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ ENHANCED OVERVIEW ANALYTICS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
async function loadAnalytics(){
  const {data:txAll} = await sb.from('transactions').select('type,amount,status,created_at');
  const {data:wallets} = await sb.from('wallets').select('tier,kyc_verified,kyc_status');

  if(txAll){
    const approved = txAll.filter(t=>t.status==='approved');
    const totalDep = approved.filter(t=>t.type==='deposit').reduce((s,t)=>s+parseFloat(t.amount||0),0);
    const totalWd  = approved.filter(t=>t.type==='withdrawal').reduce((s,t)=>s+parseFloat(t.amount||0),0);
    const el1 = document.getElementById('stat-total-dep');
    const el2 = document.getElementById('stat-total-wd');
    if(el1) el1.textContent = '$'+totalDep.toLocaleString('en',{minimumFractionDigits:2});
    if(el2) el2.textContent = '$'+totalWd.toLocaleString('en',{minimumFractionDigits:2});

    // Recent 5 transactions
    const recent = txAll.slice(0,5);
    const rtl = document.getElementById('recent-tx-list');
    if(rtl){
      rtl.innerHTML = recent.length ? recent.map(t=>`
        <div class="recent-tx-item">
          <div style="font-size:18px;">${t.type==='deposit'?'üí∞':'üí∏'}</div>
          <div style="flex:1;">
            <div style="font-size:12px;font-weight:600;">${cap(t.type)} ‚Äî $${parseFloat(t.amount||0).toLocaleString()}</div>
            <div style="font-size:10px;color:var(--gray);">${new Date(t.created_at).toLocaleDateString()}</div>
          </div>
          <span style="font-size:10px;font-weight:700;padding:2px 8px;border-radius:6px;background:${t.status==='approved'?'rgba(16,185,129,0.1)':t.status==='pending'?'rgba(245,158,11,0.1)':'rgba(239,68,68,0.1)'};color:${t.status==='approved'?'var(--green)':t.status==='pending'?'#f59e0b':'#ef4444'};">${cap(t.status)}</span>
        </div>`).join('') : '<div style="color:var(--gray);font-size:12px;padding:10px 0;">No transactions yet.</div>';
    }
  }

  if(wallets){
    // KYC stats
    const kycPending  = wallets.filter(w=>w.kyc_status==='pending'&&!w.kyc_verified).length;
    const kycVerified = wallets.filter(w=>w.kyc_verified).length;
    const kp = document.getElementById('stat-kyc');
    const kv = document.getElementById('stat-verified');
    if(kp) kp.textContent = kycPending;
    if(kv) kv.textContent = kycVerified;

    // Tier distribution bars
    const counts = {Starter:0, Growth:0, Elite:0};
    wallets.forEach(w => { const t=w.tier||'Starter'; if(counts[t]!==undefined) counts[t]++; });
    const total = wallets.length || 1;
    const tc = document.getElementById('tier-chart');
    if(tc){
      const colors = {Starter:'#3b82f6', Growth:'#10b981', Elite:'#f59e0b'};
      tc.innerHTML = Object.entries(counts).map(([tier,cnt])=>`
        <div class="tier-bar-row">
          <div class="tier-bar-label">${tier}</div>
          <div class="tier-bar-track"><div class="tier-bar-fill" style="width:${Math.round(cnt/total*100)}%;background:${colors[tier]};"></div></div>
          <div class="tier-bar-count">${cnt}</div>
        </div>`).join('');
    }
  }
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ USER DETAIL VIEW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let currentDetailUserId = null;

async function viewUserDetail(userId){
  currentDetailUserId = userId;
  showPage('user-detail', null);
  document.getElementById('ud-page-title').textContent = 'Loading...';

  let profile = null, wallet = null, txs = [];
  try {
    const results = await Promise.all([
      sb.from('profiles').select('*').eq('id',userId).single(),
      sb.from('wallets').select('*').eq('user_id',userId).single(),
      sb.from('transactions').select('*').eq('user_id',userId).order('created_at',{ascending:false}).limit(20)
    ]);
    profile = results[0].data;
    wallet  = results[1].data;
    txs     = results[2].data || [];
  } catch(e) {
    document.getElementById('ud-page-title').textContent = 'Error loading user';
    return;
  }

  const name = profile?.full_name || profile?.email || 'Unknown User';
  document.getElementById('ud-page-title').textContent = name;
  document.getElementById('ud-avatar').textContent = name.slice(0,2).toUpperCase();
  document.getElementById('ud-name').textContent = name;
  document.getElementById('ud-email').textContent = profile?.email || '--';
  // phone/age/country/address may come from profile or wallet kyc snapshot
  // Priority: profiles table (updated live) > kyc snapshot (captured at submission time)
  document.getElementById('ud-phone').textContent   = wallet?.kyc_phone   || profile?.phone   || '--';
  document.getElementById('ud-age').textContent     = wallet?.kyc_age     || profile?.age     || '--';
  document.getElementById('ud-country').textContent = wallet?.kyc_country || profile?.country || '--';
  // IMPORTANT: never fall back to kyc_full_name for address - that was the bug
  // For address: use kyc_address from wallet (set during KYC or profile save)
  // Do NOT fall back to profile.address as it may have autofill corruption
  const resolvedAddress = wallet?.kyc_address || '--';
  document.getElementById('ud-address').textContent = resolvedAddress;
  document.getElementById('ud-since').textContent   = profile?.created_at ? new Date(profile.created_at).toLocaleDateString('en',{year:'numeric',month:'long',day:'2-digit'}) : '--';

  // Tier badge
  const tier = wallet?.tier || 'Starter';
  const tierColors = {Starter:'#3b82f6',Growth:'#10b981',Elite:'#f59e0b'};
  const tc = tierColors[tier]||tierColors.Starter;
  const tb = document.getElementById('ud-tier-badge');
  if(tb){ tb.textContent=tier.toUpperCase()+' TIER'; tb.style.background=tc+'22'; tb.style.color=tc; }

  // KYC badge
  const kb = document.getElementById('ud-kyc-badge');
  if(kb){
    if(wallet?.kyc_verified){ kb.textContent='‚úÖ VERIFIED'; kb.style.background='rgba(16,185,129,0.1)'; kb.style.color='var(--green)'; }
    else if(wallet?.kyc_status==='pending'){ kb.textContent='‚è≥ KYC PENDING'; kb.style.background='rgba(245,158,11,0.1)'; kb.style.color='#f59e0b'; }
    else { kb.textContent='NOT VERIFIED'; kb.style.background='rgba(231,76,60,0.1)'; kb.style.color='#e74c3c'; }
  }

  // Wallet balances
  const fmt = v => '$'+parseFloat(v||0).toLocaleString('en',{minimumFractionDigits:2});
  document.getElementById('ud-btc').textContent = fmt(wallet?.btc_balance);
  document.getElementById('ud-stocks').textContent = fmt(wallet?.stocks_balance);
  document.getElementById('ud-forex').textContent = fmt(wallet?.forex_balance);
  const profit = parseFloat(wallet?.total_profit||0);
  const pe = document.getElementById('ud-profit');
  if(pe){ pe.textContent=(profit>=0?'+':'')+fmt(Math.abs(profit)); pe.style.color=profit>=0?'var(--green)':'#e74c3c'; }

  // Transactions
  const tbody = document.getElementById('ud-tx-table');
  if(txs && txs.length){
    tbody.innerHTML = txs.map(t=>`<tr>
      <td style="color:var(--gray);font-size:0.8rem">${new Date(t.created_at).toLocaleDateString()}</td>
      <td>${cap(t.type)}</td>
      <td style="font-weight:600;">$${parseFloat(t.amount||0).toLocaleString('en',{minimumFractionDigits:2})}</td>
      <td style="color:var(--gray);font-size:0.8rem">${t.payment_method||'--'}</td>
      <td><span class="badge badge-${t.status}">${cap(t.status)}</span></td>
    </tr>`).join('');
  } else {
    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--gray);padding:20px;">No transactions yet.</td></tr>';
  }
}

function openEditBalFromDetail(){
  if(!currentDetailUserId) return;
  const name = document.getElementById('ud-name').textContent;
  const btc  = parseFloat(document.getElementById('ud-btc').textContent.replace(/[^0-9.]/g,''))||0;
  const st   = parseFloat(document.getElementById('ud-stocks').textContent.replace(/[^0-9.]/g,''))||0;
  const fx   = parseFloat(document.getElementById('ud-forex').textContent.replace(/[^0-9.]/g,''))||0;
  const pr   = parseFloat(document.getElementById('ud-profit').textContent.replace(/[^0-9.-]/g,''))||0;
  openEditBal(currentDetailUserId, name, btc, st, fx, pr);
}

function openNotifForUser(){
  if(!currentDetailUserId) return;
  showPage('notify', document.querySelector('[onclick*=notify]'));
  setTimeout(()=>{
    const sel = document.getElementById('notif-user');
    if(sel) sel.value = currentDetailUserId;
  }, 200);
}

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ BROADCAST ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let bcAllUsers = [];

async function loadBroadcast(){
  // Load user stats
  const {data: users} = await sb.from('wallets').select('user_id,kyc_verified,tier,kyc_status');
  bcAllUsers = users || [];
  const el1 = document.getElementById('bc-total-users');
  const el2 = document.getElementById('bc-verified-users');
  if(el1) el1.textContent = bcAllUsers.length;
  if(el2) el2.textContent = bcAllUsers.filter(u=>u.kyc_verified).length;
  updateBCCount();

  // Load recent broadcasts
  const {data: hist} = await sb.from('notifications')
    .select('title,message,created_at')
    .eq('user_id','broadcast')
    .order('created_at',{ascending:false})
    .limit(5);

  // Alternatively load from a broadcasts table if it exists
  const {data: bcast} = await sb.from('broadcasts').select('*').order('created_at',{ascending:false}).limit(5);
  const bcHist = document.getElementById('bc-history');
  if(bcHist){
    const items = bcast || [];
    if(!items.length){ bcHist.innerHTML='<div style="color:var(--gray);font-size:12px;">No broadcasts sent yet.</div>'; }
    else{
      bcHist.innerHTML = items.map(b=>`
        <div style="background:var(--dark3);border:1px solid var(--border);border-radius:8px;padding:12px 14px;">
          <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:10px;">
            <div><div style="font-size:13px;font-weight:600;">${b.title||'--'}</div><div style="font-size:11px;color:var(--gray);margin-top:2px;">${b.message||''}</div></div>
            <div style="text-align:right;flex-shrink:0;"><div style="font-size:10px;color:var(--gray);">${new Date(b.created_at).toLocaleDateString()}</div><div style="font-size:10px;color:var(--blue);margin-top:2px;">${b.recipient_group||'All'}</div></div>
          </div>
        </div>`).join('');
    }
  }
}

function updateBCCount(){
  const group = document.getElementById('bc-group')?.value || 'all';
  const filters = {
    all: ()=>true,
    verified: u=>u.kyc_verified,
    unverified: u=>!u.kyc_verified,
    starter: u=>(u.tier||'Starter')==='Starter',
    growth: u=>u.tier==='Growth',
    elite: u=>u.tier==='Elite',
    pending_kyc: u=>u.kyc_status==='pending'&&!u.kyc_verified
  };
  const fn = filters[group] || filters.all;
  const count = bcAllUsers.filter(fn).length;
  const el = document.getElementById('bc-recipient-count');
  const sendEl = document.getElementById('bc-send-count');
  if(el) el.textContent = count;
  if(sendEl) sendEl.textContent = count;
}

function previewBroadcast(){
  const title = document.getElementById('bc-title')?.value?.trim();
  const msg   = document.getElementById('bc-message')?.value?.trim();
  const prev  = document.getElementById('bc-preview');
  if(!title||!msg){ showMsg(document.getElementById('bc-msg'),'Please fill in title and message first.','error'); return; }
  if(prev){
    prev.style.display = 'block';
    document.getElementById('bc-prev-title').textContent = title;
    document.getElementById('bc-prev-msg').textContent = msg;
  }
}

async function sendBroadcast(){
  const title   = document.getElementById('bc-title')?.value?.trim();
  const message = document.getElementById('bc-message')?.value?.trim();
  const group   = document.getElementById('bc-group')?.value || 'all';
  const type    = document.getElementById('bc-type')?.value  || 'info';
  const msg     = document.getElementById('bc-msg');

  if(!title)   return showMsg(msg,'Please enter a title.','error');
  if(!message) return showMsg(msg,'Please enter a message.','error');

  const filters = {
    all: ()=>true,
    verified: u=>u.kyc_verified,
    unverified: u=>!u.kyc_verified,
    starter: u=>(u.tier||'Starter')==='Starter',
    growth: u=>u.tier==='Growth',
    elite: u=>u.tier==='Elite',
    pending_kyc: u=>u.kyc_status==='pending'&&!u.kyc_verified
  };
  const fn = filters[group] || filters.all;
  const recipients = bcAllUsers.filter(fn);

  if(!recipients.length) return showMsg(msg,'No users match this filter.','error');
  if(!confirm('Send "'+title+'" to '+recipients.length+' users?')) return;

  showMsg(msg,'Sending to '+recipients.length+' users...','success');

  // Insert notification rows for each recipient
  const rows = recipients.map(u=>({
    user_id: u.user_id,
    title,
    message,
    type,
    read: false,
    created_at: new Date().toISOString()
  }));

  // Batch insert in chunks of 100
  for(let i=0;i<rows.length;i+=100){
    const {error} = await sb.from('notifications').insert(rows.slice(i,i+100));
    if(error){ showMsg(msg,'Error: '+error.message,'error'); return; }
  }

  // Log broadcast to broadcasts table
  await sb.from('broadcasts').insert({title, message, type, recipient_group:group, recipient_count:recipients.length});

  showMsg(msg,'‚úÖ Broadcast sent to '+recipients.length+' users!','success');
  document.getElementById('bc-title').value = '';
  document.getElementById('bc-message').value = '';
  document.getElementById('bc-preview').style.display = 'none';
  setTimeout(loadBroadcast, 1000);
}

function showPage(name,el){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+name).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el) el.classList.add('active');
  // Page-specific loaders
  if(name==='kyc'){ loadKYC(); updateKYCBadge(); }
  if(name==='broadcast') loadBroadcast();
  if(name==='overview') loadAnalytics();
}
function openModal(t){document.getElementById(t+'Modal').classList.add('open');}
function closeModal(t){document.getElementById(t+'Modal').classList.remove('open');}
document.querySelectorAll('.modal-overlay').forEach(m=>m.addEventListener('click',e=>{if(e.target===m)m.classList.remove('open');}));
function doLogout(){sb.auth.signOut().then(()=>window.location.href='login.html');}
function cap(s){return s.charAt(0).toUpperCase()+s.slice(1);}
function showMsg(el,text,type){el.textContent=text;el.className='msg '+type+' show';}
init();

/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ WALLET ADDRESSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ */
let walletAddrData=[];
const METHODS=['Bitcoin','Ethereum','USDT (TRC20)','USDT (ERC20)','Bank Transfer'];
const METHOD_ICONS={'Bitcoin':'‚Çø','Ethereum':'Œû','USDT (TRC20)':'‚ÇÆ','USDT (ERC20)':'‚ÇÆ','Bank Transfer':'üè¶'};

async function loadWalletAddresses(){
  const {data,error}=await sb.from('wallet_addresses').select('*').order('method').order('usage_count',{ascending:true});
  if(error){
    document.getElementById('wallet-addr-list').innerHTML='<div style="color:#fca5a5;padding:16px">Error loading addresses: '+error.message+'</div>';
    return;
  }
  walletAddrData=data||[];
  renderWalletAddresses();
}

function renderWalletAddresses(){
  const el=document.getElementById('wallet-addr-list');
  if(!walletAddrData.length){
    el.innerHTML=`<div style="text-align:center;color:#888;padding:24px;background:#1e1e1e;border-radius:10px;border:1px solid #2d2d2d">
      No wallet addresses found.<br><span style="font-size:12px;margin-top:8px;display:block">Run the SQL setup in Supabase first, then refresh this page.</span>
    </div>`;
    return;
  }
  // Group by method
  const grouped={};
  walletAddrData.forEach(a=>{
    if(!grouped[a.method]) grouped[a.method]=[];
    grouped[a.method].push(a);
  });

  el.innerHTML=METHODS.map(method=>{
    const addrs=grouped[method]||[];
    const icon=METHOD_ICONS[method]||'üí≥';
    return `<div class="wallet-addr-card">
      <h4 style="display:flex;align-items:center;justify-content:space-between;">
        <span>${icon} ${method}</span>
        <button onclick="addAddress('${method}')" style="background:#1db954;color:#fff;border:none;padding:5px 12px;border-radius:5px;font-size:11px;font-weight:700;cursor:pointer;font-family:inherit">+ Add Address</button>
      </h4>
      <div id="addrs-${method.replace(/[^a-z]/gi,'_')}">
        ${addrs.length?addrs.map((a,i)=>renderAddrRow(a)).join(''):'<div style="color:#888;font-size:12px;padding:8px 0">No addresses yet. Click + Add Address.</div>'}
      </div>
    </div>`;
  }).join('');
}

function renderAddrRow(a){
  return `<div class="addr-row" id="row-${a.id}" style="display:flex;gap:8px;align-items:center;margin-bottom:8px;">
    <div style="flex:1">
      <input class="wallet-addr-input" id="inp-${a.id}" type="text" value="${a.address||''}" placeholder="Enter address..." style="margin-bottom:4px"/>
      <input class="wallet-addr-input" id="lbl-${a.id}" type="text" value="${a.label||''}" placeholder="Label (e.g. Wallet 1)" style="font-size:11px;padding:6px 10px;color:#888"/>
    </div>
    <div style="display:flex;flex-direction:column;gap:4px;align-items:center">
      <button class="toggle-switch ${a.is_active?'on':''}" id="toggle-${a.id}" onclick="toggleOne('${a.id}')"></button>
      <span style="font-size:10px;color:#888">${a.usage_count||0} uses</span>
      <button onclick="deleteAddress('${a.id}')" style="background:rgba(231,76,60,0.1);color:#e74c3c;border:1px solid rgba(231,76,60,0.2);padding:3px 8px;border-radius:4px;font-size:11px;cursor:pointer">Del</button>
    </div>
  </div>`;
}

function toggleOne(id){
  const a=walletAddrData.find(x=>x.id===id);
  if(!a) return;
  a.is_active=!a.is_active;
  const btn=document.getElementById('toggle-'+id);
  btn.className='toggle-switch '+(a.is_active?'on':'');
}

async function addAddress(method){
  const {data,error}=await sb.from('wallet_addresses').insert({
    method:method,address:'',label:'',is_active:true,usage_count:0
  }).select().single();
  if(error){alert('Error: '+error.message);return;}
  walletAddrData.push(data);
  renderWalletAddresses();
  // Focus the new input
  setTimeout(()=>{
    const inp=document.getElementById('inp-'+data.id);
    if(inp) inp.focus();
  },100);
}

async function deleteAddress(id){
  if(!confirm('Delete this address? This cannot be undone.')) return;
  const {error}=await sb.from('wallet_addresses').delete().eq('id',id);
  if(error){alert('Error: '+error.message);return;}
  walletAddrData=walletAddrData.filter(a=>a.id!==id);
  renderWalletAddresses();
}

async function saveWalletAddresses(){
  const msg=document.getElementById('wallet-save-msg');
  msg.style.display='none';
  let errors=[];
  let saved=0;

  for(const a of walletAddrData){
    const inpEl=document.getElementById('inp-'+a.id);
    const lblEl=document.getElementById('lbl-'+a.id);
    if(!inpEl) continue;
    const newAddr=inpEl.value.trim();
    const newLbl=lblEl?lblEl.value.trim():'';
    const {error}=await sb.from('wallet_addresses').update({
      address:newAddr,
      label:newLbl,
      is_active:a.is_active
    }).eq('id',a.id);
    if(error) errors.push(a.method+': '+error.message);
    else{a.address=newAddr;a.label=newLbl;saved++;}
  }

  msg.style.display='block';
  if(errors.length){
    msg.style.color='#fca5a5';
    msg.textContent='Saved '+saved+', errors: '+errors.join('; ');
  } else {
    msg.style.color='#6ee7b7';
    msg.textContent='‚úÖ '+saved+' address(es) saved! Users will see updated addresses on next deposit.';
    setTimeout(()=>{msg.style.display='none';},4000);
  }
}

</script>
</body>
</html>
